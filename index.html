<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VEGAS 7 NUMBERS</title>
    <style>
        /* CSS per la ReattivitÃ  e lo Stile */
        :root {
            --green-bg: #4CAF50;
            --light-gray-bg: #f0f0f0;
            --red-btn: #f44336;
            --blue-btn: #2196F3;
            --text-color: #333;
            --border-color: #ccc;
            --light-green: #e8ffe8;
            --win-green: #2ecc71;
            --dark-blue: #34495e;
            --disabled-color: #95a5a6;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--green-bg);
            color: var(--text-color);
        }

        /* STILE INTESTAZIONE IMMAGINE */
        .header-image-container {
            text-align: center;
            padding: 10px 0;
            margin: 0;
        }
        .header-image-container img {
            max-width: 100%;
            height: auto;
            max-height: 100px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
        }

        /* Gestione delle Pagine */
        .page-content {
            display: none;
        }
        #main-page {
            display: block;
        }
        
        /* Area Input Principale */
        .input-area {
            background-color: var(--light-gray-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        /* Campi di Input */
        .input-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .input-group label {
            font-weight: bold;
            flex-basis: 100%;
        }
        .input-group input[type="number"],
        .input-group .calculated-field {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
            flex-grow: 1;
            min-width: 120px;
        }
        .input-group .calculated-field {
            background-color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            min-height: 40px;
        }

        /* Bottoni */
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: space-around;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            flex-grow: 1;
            max-width: 200px;
            transition: background-color 0.3s;
        }
        .btn-red { background-color: var(--red-btn); }
        .btn-blue { background-color: var(--blue-btn); }
        .btn:hover:not(:disabled) { opacity: 0.9; }

        .btn-archive-action {
            background-color: var(--dark-blue);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            flex-grow: 1;
        }
        .btn-archive-action:disabled {
            background-color: var(--disabled-color);
            cursor: not-allowed;
        }

        .data-section {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: space-around;
        }
        .extracted-numbers-container, .suggested-numbers-area {
            flex: 1 1 200px;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .suggested-numbers-area { text-align: center; }
        #numeri-suggeriti {
            font-size: 1.8em;
            color: var(--win-green);
            margin: 10px 0 0;
            word-wrap: break-word;
        }
        .extracted-numbers-table { width: 100%; border-collapse: collapse; }
        .extracted-numbers-table th, .extracted-numbers-table td { border: 1px solid var(--border-color); padding: 8px; text-align: center; }

        .data-table-container {
            flex: 3 1 400px;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { border: 1px solid #000; padding: 8px 5px; text-align: center; font-size: 0.9em; }
        .data-table th { background-color: #e0e0e0; }

        .evidenziato { background-color: #ffffa8 !important; color: #333; font-weight: bold; }
        .riga-bruciata { background-color: #ff4d4d !important; color: white; font-weight: bold; }
        .riga-bruciata td { background-color: transparent !important; color: white; }

        .progression-section {
            background-color: white;
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }
        .progression-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }
        .progression-table th, .progression-table td {
            border: 1px solid #000;
            padding: 6px 4px;
            text-align: center;
        }
        .progression-table thead th {
            background-color: #333;
            color: white;
            font-size: 0.9em;
        }
        .header-big { background-color: #555 !important; }
        .header-medio { background-color: #e67e22 !important; }
        .header-mini { background-color: #27ae60 !important; }

        .active-step {
            background-color: var(--light-green) !important;
            font-weight: bold;
        }
        .reset-progression-btn {
            background-color: var(--dark-blue);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            display: block;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        
        /* STILI PAGINA STATISTICHE (RIDUZIONE FONT/PADDING) */
        #stats-page {
            background-color: var(--light-gray-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .stats-summary, .stats-sessions {
            margin-bottom: 20px;
        }
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.9em;
        }
        .stats-table th, .stats-table td {
            border: 1px solid var(--border-color);
            padding: 8px;
            text-align: center;
        }
        .stats-table th {
            background-color: #ddd;
        }
        .positive-saldo { color: var(--win-green); font-weight: bold; }
        .negative-saldo { color: var(--red-btn); font-weight: bold; }

        /* Media Query per schermi grandi */
        @media (min-width: 600px) {
            .input-group label { flex-basis: auto; margin-right: 10px; }
            .input-group { justify-content: space-between; }
            .input-group input[type="number"], .input-group .calculated-field { flex-grow: 0; width: calc(33% - 15px); }
            .action-buttons button { max-width: 200px; }
        }
    </style>
</head>
<body>

    <div class="header-image-container">
        <img src="https://raw.githubusercontent.com/mauro8274/Provavegas/81a5c6465ecb5ed1ef903dcc9d2ddeff69d04964/IMG_0628.jpeg" alt="Logo Vegas 7 Numbers">
    </div>

    <div class="container">
        
        <div id="main-page" class="page-content">
            
            <div class="input-area">
                
                <div class="input-group">
                    <label for="numero-estratto">Numero Estratto (0-36):</label>
                    <input type="number" id="numero-estratto" min="0" max="36" inputmode="numeric" pattern="[0-9]*" placeholder="Inserisci numero" autofocus>
                    
                    <label for="valore-unitario">Valore Unitario (â‚¬):</label>
                    <input type="text" id="valore-unitario" placeholder="0,10"> <label>Saldo Real Time:</label>
                    <div id="saldo-real-time" class="calculated-field">â‚¬ 0.00</div>
                </div>

                <div class="button-group">
                    <button id="reset-numeri" class="btn btn-red">Reset numeri</button>
                    <button id="visualizza-archivio" class="btn btn-blue">Visualizza archivio</button>
                </div>
                
                <div class="action-buttons">
                    <button id="archivia-saldo" class="btn-archive-action" disabled>Archivia Saldo Corrente</button>
                    <button id="richiama-ultimi" class="btn-archive-action" disabled>Richiama Ultimi 10 Numeri</button>
                </div>
            </div>
            
            <hr>

            <div class="suggested-numbers-area">
                <h3>I Numeri Suggeriti:</h3>
                <p id="numeri-suggeriti">Attendendo la Logica...</p>
            </div>

            <hr>

            <div class="progression-section">
                <h3>PROGRESSIONE PUNTATE</h3>
                <table class="progression-table">
                    <thead>
                        <tr id="progression-header">
                            <th>STEP</th>
                            <th class="header-big">BIG: <span id="big-number">?</span></th>
                            <th class="header-medio">MEDIO: <span id="medio1-number">?</span></th>
                            <th class="header-medio">MEDIO: <span id="medio2-number">?</span></th>
                            <th class="header-mini">MINI: <span id="mini1-number">?</span></th>
                            <th class="header-mini">MINI: <span id="mini2-number">?</span></th>
                            <th class="header-mini">MINI: <span id="mini3-number">?</span></th>
                            <th class="header-mini">MINI: <span id="mini4-number">?</span></th>
                        </tr>
                    </thead>
                    <tbody id="progression-body">
                        </tbody>
                </table>
                <button id="reset-progressione" class="reset-progression-btn">RESET PROGRESSIONE</button>
            </div>

            <hr>

            <div class="data-section">
                
                <div class="extracted-numbers-container">
                    <h3>Numeri Estratti</h3>
                    <table class="extracted-numbers-table">
                        <thead><tr><th>Numero</th></tr></thead>
                        <tbody id="lista-estratti"></tbody>
                    </table>
                </div>

                <div class="data-table-container">
                    <h3>TABELLA DATI</h3>
                    <table class="data-table" id="tabella-dati">
                        <tbody>
                            <tr><td>2</td><td>1</td><td>3</td><td>36</td><td>4</td><td>34</td><td>6</td></tr>
                            <tr><td>5</td><td>4</td><td>6</td><td>1</td><td>9</td><td>3</td><td>7</td></tr>
                            <tr><td>8</td><td>9</td><td>7</td><td>4</td><td>12</td><td>6</td><td>10</td></tr>
                            <tr><td>11</td><td>12</td><td>10</td><td>9</td><td>13</td><td>7</td><td>15</td></tr>
                            <tr><td>14</td><td>13</td><td>15</td><td>12</td><td>16</td><td>10</td><td>18</td></tr>
                            <tr><td>17</td><td>16</td><td>18</td><td>13</td><td>21</td><td>15</td><td>19</td></tr>
                            <tr><td>20</td><td>21</td><td>19</td><td>16</td><td>24</td><td>18</td><td>22</td></tr>
                            <tr><td>23</td><td>24</td><td>22</td><td>21</td><td>25</td><td>19</td><td>27</td></tr>
                            <tr><td>26</td><td>25</td><td>27</td><td>24</td><td>28</td><td>22</td><td>30</td></tr>
                            <tr><td>29</td><td>28</td><td>30</td><td>25</td><td>33</td><td>27</td><td>31</td></tr>
                            <tr><td>32</td><td>33</td><td>31</td><td>28</td><td>36</td><td>30</td><td>34</td></tr>
                            <tr><td>35</td><td>36</td><td>34</td><td>33</td><td>1</td><td>31</td><td>3</td></tr>
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
        
        <div id="stats-page" class="page-content">
            <h2>ðŸ“Š Archivio e Statistiche Sessioni</h2>
            
            <div class="stats-summary">
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>SALDO TOTALE</th>
                            <th>NUMERO EVENTI</th>
                            <th>VITTORIE</th>
                            <th>PERDITE</th>
                            <th>% VITTORIE</th>
                        </tr>
                    </thead>
                    <tbody id="summary-body">
                        <tr>
                            <td id="total-saldo">â‚¬ 0.00</td>
                            <td id="total-events">0</td>
                            <td id="total-wins">0</td>
                            <td id="total-losses">0</td>
                            <td id="win-percentage">0%</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="button-group" style="justify-content: center;">
                <button id="back-to-main" class="btn btn-blue">Torna alla Pagina Principale</button>
                <button id="reset-archivio" class="btn btn-red">Reset Archivio Statistiche</button>
            </div>
            
            <div class="stats-sessions">
                <h3>Dettaglio Sessioni Archiviate</h3>
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>Data/Ora</th>
                            <th>Saldo Registrato</th>
                            <th>Step Vittoria</th>
                        </tr>
                    </thead>
                    <tbody id="sessions-body">
                        </tbody>
                </table>
            </div>
        </div>
        
    </div>

    <script>
        // ===============================================
        // CONFIGURAZIONE JSONBIN.IO (CLOUD STORAGE)
        // ===============================================
        // CHIAVE API: Tua Nuova Master Key
        const JSON_BIN_API_KEY = "$2a$10$jyfQtGxraAzGJat.A7ksZ.Z4RQ2Tjzx3YvAwd7Ro.seCzFmfE3PyC";
        
        // ID BIN: STATISTICHE E NUMERI (BIN PUBBLICI CONFERMATI)
        const STATS_BIN_ID = "69395cce43b1c97be9e44dcc";
        const NUMBERS_BIN_ID = "69395cc443b1c97be9e44dbe";
        
        // ===============================================
        // VARIABILI GLOBALI e STRUTTURE DATI
        // ===============================================
        const inputEstratto = document.getElementById('numero-estratto');
        const valoreUnitarioInput = document.getElementById('valore-unitario');
        const listaEstratti = document.getElementById('lista-estratti');
        const saldoRealTime = document.getElementById('saldo-real-time');
        const btnResetNumeri = document.getElementById('reset-numeri');
        const btnResetProgressione = document.getElementById('reset-progressione');
        const btnArchiviaSaldo = document.getElementById('archivia-saldo');
        const btnVisualizzaArchivio = document.getElementById('visualizza-archivio');
        const btnRichiamaUltimi = document.getElementById('richiama-ultimi');
        const btnTornaAllaPaginaPrincipale = document.getElementById('back-to-main');
        const btnResetArchivio = document.getElementById('reset-archivio');
        
        const mainPage = document.getElementById('main-page');
        const statsPage = document.getElementById('stats-page');
        const progressionBody = document.getElementById('progression-body');
        const tabellaDatiElemento = document.getElementById('tabella-dati');
        const suggestedNumbersElement = document.getElementById('numeri-suggeriti');
        const righeTabella = tabellaDatiElemento.querySelectorAll('tbody tr');
        
        const sessionsBody = document.getElementById('sessions-body'); // Per la tabella statistiche
        const totalSaldoElement = document.getElementById('total-saldo');
        const totalEventsElement = document.getElementById('total-events');
        const totalWinsElement = document.getElementById('total-wins');
        const totalLossesElement = document.getElementById('total-losses');
        const winPercentageElement = document.getElementById('win-percentage');


        const TABELLA_DATI = [
            [2, 1, 3, 36, 4, 34, 6], [5, 4, 6, 1, 9, 3, 7], [8, 9, 7, 4, 12, 6, 10],
            [11, 12, 10, 9, 13, 7, 15], [14, 13, 15, 12, 16, 10, 18], [17, 16, 18, 13, 21, 15, 19],
            [20, 21, 19, 16, 24, 18, 22], [23, 24, 22, 21, 25, 19, 27], [26, 25, 27, 24, 28, 22, 30],
            [29, 28, 30, 25, 33, 27, 31], [32, 33, 31, 28, 36, 30, 34], [35, 36, 34, 33, 1, 31, 3]
        ];
        const MEDI_PER_RIGA = {
            0: [1, 3], 1: [4, 6], 2: [9, 7], 3: [12, 10], 4: [13, 15], 5: [16, 18],
            6: [21, 19], 7: [24, 22], 8: [25, 27], 9: [28, 30], 10: [33, 31], 11: [36, 34]
        };

        const PROGRESSION_MULTIPLIERS = [
            { BIG: 4, MEDI: 2, MINI: 1 }, { BIG: 4, MEDI: 2, MINI: 1 }, { BIG: 4, MEDI: 2, MINI: 1 },
            { BIG: 6, MEDI: 4, MINI: 1 }, { BIG: 6, MEDI: 4, MINI: 2 }, { BIG: 10, MEDI: 8, MINI: 4 },
            { BIG: 8, MEDI: 4, MINI: 0 },
            { BIG: 8, MEDI: 5, MINI: 0 },
            { BIG: 10, MEDI: 5, MINI: 0 },
            { BIG: 10, MEDI: 6, MINI: 0 },
            { BIG: 12, MEDI: 8, MINI: 0 },
            { BIG: 12, MEDI: 8, MINI: 0 },
            { BIG: 8, MEDI: 8, MINI: 0 },
            { BIG: 9, MEDI: 9, MINI: 0 },
            { BIG: 10, MEDI: 10, MINI: 0 },
            { BIG: 11, MEDI: 11, MINI: 0 },
            { BIG: 12, MEDI: 12, MINI: 0 },
            { BIG: 12, MEDI: 12, MINI: 0 },
            { BIG: 13, MEDI: 13, MINI: 0 },
            { BIG: 15, MEDI: 15, MINI: 0 }
        ];

        // STATO GLOBALE PAGINA PRINCIPALE
        let numeriEstratti = [];
        let righeBruciate = new Array(12).fill(false);
        let mediUscitiPerRiga = new Array(12).fill(0).map(() => new Set());
        let isBettingPhase = false;
        let suggestedNumbers = null;
        let currentStep = 0;
        let currentSaldo = 0;
        let winStepForArchive = null;
        let sessionArchives = []; // Contiene tutti i dati archiviati delle sessioni


        // ===============================================
        // FUNZIONI CLOUD STORAGE (JSONBIN.IO)
        // ===============================================
        async function fetchInitialData() {
            await fetchStatsFromCloud();
            await fetchNumbersFromCloud();
            // Inizializzazione basata sui dati recuperati
            updateEstrattiList();
            initializeProgressionTable();
            checkRichiamaUltimiButtonState();
            reapplyBruciateAndEvidenziate();
        }
        
        async function fetchStatsFromCloud() {
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${STATS_BIN_ID}/latest`, {
                    headers: {
                        'X-Master-Key': JSON_BIN_API_KEY
                    }
                });
                const data = await response.json();
                if (data.record && data.record.sessions) {
                    sessionArchives = data.record.sessions;
                } else {
                    console.log('Archivio statistiche vuoto o non valido nel cloud.');
                }
            } catch (error) {
                console.error("Errore nel caricamento statistiche da cloud:", error);
            }
        }
        
        async function saveStatsToCloud() {
            try {
                const dataToSave = { sessions: sessionArchives };
                const response = await fetch(`https://api.jsonbin.io/v3/b/${STATS_BIN_ID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSON_BIN_API_KEY
                    },
                    body: JSON.stringify(dataToSave)
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                console.log('Statistiche salvate su cloud con successo.');
            } catch (error) {
                console.error("Errore nel salvataggio statistiche su cloud:", error);
                alert("ATTENZIONE: Errore nel salvataggio delle statistiche su JSONBIN.");
            }
        }

        async function fetchNumbersFromCloud() {
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${NUMBERS_BIN_ID}/latest`, {
                    headers: {
                        'X-Master-Key': JSON_BIN_API_KEY
                    }
                });
                const data = await response.json();
                if (data.record && data.record.numbers) {
                    numeriEstratti = data.record.numbers;
                    righeBruciate = data.record.righeBruciate || new Array(12).fill(false);
                    currentSaldo = data.record.currentSaldo || 0;
                    // Ricostruisci mediUscitiPerRiga se necessario, ma per semplicitÃ  ora ci affidiamo solo a bruciate e numeri
                } else {
                    console.log('Archivio numeri vuoto o non valido nel cloud.');
                }
            } catch (error) {
                console.error("Errore nel caricamento numeri da cloud:", error);
            }
        }
        
        async function saveNumbersToCloud() {
            try {
                const dataToSave = { 
                    numbers: numeriEstratti, 
                    righeBruciate: righeBruciate,
                    currentSaldo: currentSaldo 
                };
                const response = await fetch(`https://api.jsonbin.io/v3/b/${NUMBERS_BIN_ID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSON_BIN_API_KEY
                    },
                    body: JSON.stringify(dataToSave)
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                console.log('Numeri e stato salvati su cloud con successo.');
                saldoRealTime.textContent = formatCurrency(currentSaldo); // Aggiorna visualizzazione
            } catch (error) {
                console.error("Errore nel salvataggio numeri su cloud:", error);
                alert("ATTENZIONE: Errore nel salvataggio dei numeri su JSONBIN.");
            }
        }

        // ===============================================
        // FUNZIONI UTILITY E DI GIOCO
        // ===============================================
        const formatCurrency = (value) => `â‚¬ ${value.toFixed(2).replace('.', ',')}`;
        
        function getUnitValue() {
             const value = valoreUnitarioInput.value.replace(',', '.');
             return parseFloat(value) || 0;
        }

        function calculateStake(step, unitValue) {
            if (step < 1 || step > 20) return null;
            const mult = PROGRESSION_MULTIPLIERS[step - 1];
            
            const bigBet = mult.BIG * unitValue;
            const medioBet = mult.MEDI * unitValue;
            const miniBet = mult.MINI * unitValue;
            
            // La puntata totale include 1 BIG, 2 MEDI, 4 MINI (dove i MINI non sono a zero)
            const totalBetBig = bigBet;
            const totalBetMedi = 2 * medioBet;
            const totalBetMini = 4 * miniBet; // SarÃ  zero se mult.MINI Ã¨ 0
            
            const totalStake = totalBetBig + totalBetMedi + totalBetMini;

            return { bigBet, medioBet, miniBet, totalStake };
        }

        function initializeProgressionTable() {
            progressionBody.innerHTML = '';
            
            const unitValue = getUnitValue() || 0.10;
            
            if (!valoreUnitarioInput.value || getUnitValue() <= 0) {
                 valoreUnitarioInput.value = unitValue.toFixed(2).replace('.', ',');
            }
            
            PROGRESSION_MULTIPLIERS.forEach((mult, index) => {
                const step = index + 1;
                const riga = progressionBody.insertRow();
                riga.id = `step-row-${step}`;
                
                const bigBet = mult.BIG * unitValue;
                const medioBet = mult.MEDI * unitValue;
                const miniBet = mult.MINI * unitValue;

                riga.innerHTML = `
                    <td>STEP ${step}</td>
                    <td>${formatCurrency(bigBet)}</td>
                    <td>${formatCurrency(medioBet)}</td>
                    <td>${formatCurrency(medioBet)}</td>
                    <td>${formatCurrency(miniBet)}</td>
                    <td>${formatCurrency(miniBet)}</td>
                    <td>${formatCurrency(miniBet)}</td>
                    <td>${formatCurrency(miniBet)}</td>
                `;
            });
            if (currentStep > 0) {
                 highlightStep(currentStep);
            }
            saldoRealTime.textContent = formatCurrency(currentSaldo);
        }
        
        function highlightStep(newStep) {
            if (currentStep >= 1 && currentStep <= 20) {
                const prevRow = document.getElementById(`step-row-${currentStep}`);
                if (prevRow) prevRow.classList.remove('active-step');
            }
            
            if (newStep >= 1 && newStep <= 20) {
                const newRow = document.getElementById(`step-row-${newStep}`);
                if (newRow) newRow.classList.add('active-step');
            }
            currentStep = newStep;
            
            // Se usciamo dalla fase di progressione (newStep = 0 o Win), resetta l'header
            if (newStep === 0) {
                updateProgressionHeader([]);
                updateSuggestedNumbers(null);
            } else if (suggestedNumbers) {
                updateProgressionHeader(suggestedNumbers);
                updateSuggestedNumbers(suggestedNumbers);
            }
        }

        function resetProgressionState() {
             isBettingPhase = false;
             suggestedNumbers = null;
             highlightStep(0);
             inputEstratto.disabled = false;
        }

        function updateProgressionHeader(numbers) {
            document.getElementById('big-number').textContent = numbers[0] || '?';
            document.getElementById('medio1-number').textContent = numbers[1] || '?';
            document.getElementById('medio2-number').textContent = numbers[2] || '?';
            
            // Regola: Nascondi i MINI nell'intestazione se Step >= 7
            const miniDisplay = (isBettingPhase && currentStep >= 7) ? 'â€”' : (numbers[3] || '?');
            document.getElementById('mini1-number').textContent = miniDisplay;
            document.getElementById('mini2-number').textContent = miniDisplay;
            document.getElementById('mini3-number').textContent = miniDisplay;
            document.getElementById('mini4-number').textContent = miniDisplay;
        }
        
        function updateEstrattiList() {
            listaEstratti.innerHTML = '';
            const maxDisplay = 30;
            numeriEstratti.slice(0, maxDisplay).forEach(numero => {
                const row = listaEstratti.insertRow();
                const cell = row.insertCell();
                cell.textContent = numero;
            });
        }
        
        function updateSuggestedNumbers(numbers) {
            if (numbers && numbers.length > 0) {
                
                let numbersToDisplay = [...numbers];

                // Regola: Mostra solo i 3 numeri se siamo in fase di scommessa e lo step Ã¨ 7 o superiore
                if (isBettingPhase && currentStep >= 7) {
                    numbersToDisplay = [numbers[0], numbers[1], numbers[2]];
                }
                
                suggestedNumbersElement.innerHTML = `<strong>${numbersToDisplay.join(', ')}</strong>`;
            } else {
                suggestedNumbersElement.textContent = 'Attendendo la Logica...';
            }
        }

        function reapplyBruciateAndEvidenziate() {
            // 1. Reset visivo
            righeTabella.forEach(row => {
                row.classList.remove('riga-bruciata');
                row.querySelectorAll('td').forEach(cell => cell.classList.remove('evidenziato'));
            });

            // 2. Riapplica le bruciate
            righeBruciate.forEach((bruciata, index) => {
                if (bruciata) {
                    righeTabella[index].classList.add('riga-bruciata');
                }
            });
            
            // 3. Riapplica le evidenziazioni
            // Simula l'estrazione di tutti i numeri archiviati per riapplicare le classi 'evidenziato' e 'riga-bruciata'
            // NOTA: Non chiamiamo tracciaNumeroPreGame direttamente, ma solo la parte visiva se non siamo in betting phase.
            if (!isBettingPhase) {
                const currentRigheBruciate = new Array(12).fill(false);
                
                numeriEstratti.slice().reverse().forEach(numero => { // Analizza in ordine di estrazione
                    TABELLA_DATI.forEach((rigaDati, rigaIndex) => {
                        if (currentRigheBruciate[rigaIndex]) return;

                        rigaDati.forEach((valore, colonnaIndex) => {
                            if (valore === numero) {
                                // Se la riga non era ancora bruciata
                                if (!righeBruciate[rigaIndex] && !righeTabella[rigaIndex].classList.contains('riga-bruciata')) {
                                    const cella = righeTabella[rigaIndex].cells[colonnaIndex];
                                    cella.classList.add('evidenziato');
                                }
                            }
                        });
                        
                        // Si basa sullo stato globale righeBruciate per applicare la classe 'riga-bruciata'
                        if (righeBruciate[rigaIndex]) {
                           currentRigheBruciate[rigaIndex] = true;
                           righeTabella[rigaIndex].classList.add('riga-bruciata');
                        }
                    });
                });
            }
        }
        
        function checkIfRowBruciata(rigaIndex, numeroEstratto) {
            if (righeBruciate[rigaIndex]) return;

            const datiRiga = TABELLA_DATI[rigaIndex];
            if (datiRiga[0] === numeroEstratto) {
                // Colonna BIG
                righeBruciate[rigaIndex] = true;
                righeTabella[rigaIndex].classList.add('riga-bruciata');
                return;
            }

            const numeriMedi = MEDI_PER_RIGA[rigaIndex];
            if (numeriMedi.includes(numeroEstratto)) {
                // Colonne MEDI
                mediUscitiPerRiga[rigaIndex].add(numeroEstratto);
                
                if (mediUscitiPerRiga[rigaIndex].size === 2) {
                    righeBruciate[rigaIndex] = true;
                    righeTabella[rigaIndex].classList.add('riga-bruciata');
                }
            }
        }
        
        function updateSaldoLoss() {
             const unitValue = getUnitValue();
             const currentStake = calculateStake(currentStep, unitValue);

             if (currentStake) {
                currentSaldo -= currentStake.totalStake;
                saldoRealTime.textContent = formatCurrency(currentSaldo);
             }
        }
        
        function triggerBettingPhase(rigaIndex, rigaDati) {
            const unitValue = getUnitValue();
            if (unitValue <= 0) {
                 alert('ATTENZIONE: Inserisci prima un "Valore Unitario â‚¬" valido per iniziare la progressione.');
                 isBettingPhase = false;
                 suggestedNumbers = null;
                 return;
            }

            // Reset delle evidenziazioni della riga che ha fatto partire il gioco
            righeTabella[rigaIndex].querySelectorAll('.evidenziato').forEach(cell => cell.classList.remove('evidenziato'));


            isBettingPhase = true;
            suggestedNumbers = rigaDati;
            
            updateProgressionHeader(rigaDati);
            updateSuggestedNumbers(rigaDati);
            
            highlightStep(1);
            updateSaldoLoss(); // PRIMA perdita (Step 1)
            
            const numeri = rigaDati.join(', ');
            alert(`CI SIAMO! I 7 numeri da giocare sono: ${numeri}`);
            
            checkArchiviaButtonState();
            checkRichiamaUltimiButtonState();
        }

        function archiveCurrentSession() {
            if (winStepForArchive === null) {
                alert("Non c'Ã¨ una sessione vincente da archiviare. Estrai un numero vincente prima di archiviare.");
                return;
            }

            const now = new Date();
            const sessionData = {
                date: now.toLocaleString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }),
                saldo: currentSaldo,
                winStep: winStepForArchive,
                win: true, // Segna come vittoria
            };

            sessionArchives.push(sessionData);
            saveStatsToCloud();
            
            // Logica per preparare una nuova sessione dopo l'archiviazione:
            resetProgressionState();
            winStepForArchive = null;
            
            alert(`Sessione archiviata con successo! Saldo: ${formatCurrency(sessionData.saldo)}, Vittoria allo Step ${sessionData.winStep}.`);
            checkArchiviaButtonState();
        }
        
        function processBettingPhase(numeroEstratto) {
            const unitValue = getUnitValue();
            const currentStake = calculateStake(currentStep, unitValue);
            
            if (!currentStake) return;

            let isWin = false;
            let winIndex = -1;
            
            // Regola: Se Step >= 7, consideriamo solo i primi 3 numeri (BIG e 2 MEDI)
            let checkNumbers = suggestedNumbers;
            if (currentStep >= 7) {
                checkNumbers = suggestedNumbers.slice(0, 3);
            }
            
            if (checkNumbers.includes(numeroEstratto)) {
                 isWin = true;
                 winIndex = suggestedNumbers.indexOf(numeroEstratto);
            }

            if (isWin) {
                let betOnWinNumber = 0;
                
                // Determina la puntata specifica sul numero vincente
                if (winIndex === 0) { // BIG
                    betOnWinNumber = currentStake.bigBet;
                } else if (winIndex === 1 || winIndex === 2) { // MEDI
                    betOnWinNumber = currentStake.medioBet;
                } else if (winIndex >= 3 && currentStep <= 6) { // MINI (Solo fino allo Step 6)
                    betOnWinNumber = currentStake.miniBet;
                }
                
                const winLord = betOnWinNumber * 36;
                
                // Calcola il netto: winLord (vincita lorda) - currentStake.totalStake (puntata totale) + (puntata totale giÃ  tolta)
                // In questo caso, ri-aggiungiamo la puntata persa in questo step, e poi aggiungiamo la vincita netta
                // Simplificando: aggiungiamo la vincita lorda (che include la puntata vincente, giÃ  tolta)
                // Il saldo Ã¨ stato decrementato prima di questo step, quindi aggiungiamo solo la vincita lorda
                currentSaldo += winLord;
                
                saldoRealTime.textContent = formatCurrency(currentSaldo);
                winStepForArchive = currentStep;
                
                // Disabilita l'input finchÃ© la sessione non viene archiviata
                inputEstratto.disabled = true;
                
                // MESSAGGIO DI VINCITA AGGIORNATO
                alert(`HAI VINTO ${formatCurrency(winLord)}!! Il saldo Real time aggiornato Ã¨ ${formatCurrency(currentSaldo)}. ARCHIVIA ORA!`);
                
            } else {
                if (currentStep < 20) {
                    currentStep++;
                    highlightStep(currentStep);
                    updateSaldoLoss();
                    
                    updateSuggestedNumbers(suggestedNumbers);
                    updateProgressionHeader(suggestedNumbers || []);

                } else {
                    // C'Ã¨ stata una perdita totale al passo 20
                    const now = new Date();
                    const sessionData = {
                        date: now.toLocaleString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }),
                        saldo: currentSaldo,
                        winStep: 0, // 0 indica nessuna vincita
                        win: false,
                    };
                    sessionArchives.push(sessionData);
                    saveStatsToCloud();
                    
                    alert("Progressione terminata all'ultimo Step (20). Sessione archiviata come perdita totale. Resetta per iniziare una nuova giocata.");
                    resetProgressionState();
                }
            }
            checkArchiviaButtonState();
            checkRichiamaUltimiButtonState();
            saveNumbersToCloud(); // Salva lo stato dopo ogni estrazione in fase di scommessa
        }
        
        function tracciaNumeroPreGame(numero, analyzeOnly = false) {
             let winTriggered = false;

            TABELLA_DATI.forEach((rigaDati, rigaIndex) => {
                if (winTriggered) return;

                rigaDati.forEach((valore, colonnaIndex) => {
                    if (valore === numero) {
                        const rigaElemento = righeTabella[rigaIndex];
                        const cella = rigaElemento.cells[colonnaIndex];
                        
                        let nuovaEvidenziazione = false;
                        if (!righeBruciate[rigaIndex]) {
                            if (!cella.classList.contains('evidenziato')) {
                                cella.classList.add('evidenziato');
                                nuovaEvidenziazione = true;
                            }
                        }
                        
                        if (!righeBruciate[rigaIndex] && nuovaEvidenziazione) {
                            const evidenziateNellaRiga = rigaElemento.querySelectorAll('.evidenziato').length;

                            if (evidenziateNellaRiga === 4) {
                                if (!analyzeOnly) {
                                    triggerBettingPhase(rigaIndex, rigaDati);
                                }
                                winTriggered = true;
                                return;
                            }
                        }
                        
                        if (!righeBruciate[rigaIndex] && !winTriggered) {
                            checkIfRowBruciata(rigaIndex, numero);
                        }
                    }
                });
            });
             return winTriggered;
        }

        // ===============================================
        // GESTIONE EVENTI (MAIN LOGIC FLOW)
        // ===============================================
        
        function handleNumberInput() {
            const numero = parseInt(inputEstratto.value);
            inputEstratto.value = ''; // Pulisci immediatamente l'input

            if (isNaN(numero) || numero < 0 || numero > 36) {
                alert("Per favore, inserisci un numero valido tra 0 e 36.");
                return;
            }

            // 1. Aggiungi alla lista globale e salva
            numeriEstratti.unshift(numero); // Aggiungi all'inizio
            updateEstrattiList();
            
            // 2. Logica di gioco
            if (isBettingPhase) {
                processBettingPhase(numero);
            } else {
                const winTriggered = tracciaNumeroPreGame(numero);
                if (!winTriggered) {
                    // Nessuna progressione iniziata, salva lo stato
                    saveNumbersToCloud();
                }
            }
            
            // 3. Reset dello stato di input dopo l'elaborazione (riabilita se non in vincita)
            if (winStepForArchive === null) {
                inputEstratto.disabled = false;
            }
        }
        
        // ===============================================
        // GESTIONE BOTTONI E VISTE
        // ===============================================

        function resetAllNumbers() {
            if (!confirm('Sei sicuro di voler resettare tutti i numeri estratti e lo stato della Tabella Dati (righe, evidenziazioni)?')) return;

            numeriEstratti = [];
            righeBruciate = new Array(12).fill(false);
            mediUscitiPerRiga = new Array(12).fill(0).map(() => new Set());
            
            righeTabella.forEach(row => {
                row.classList.remove('riga-bruciata');
                row.querySelectorAll('td').forEach(cell => cell.classList.remove('evidenziato'));
            });
            
            resetProgressionState();
            currentSaldo = 0;
            winStepForArchive = null;
            
            updateEstrattiList();
            saveNumbersToCloud();
            checkRichiamaUltimiButtonState();
            checkArchiviaButtonState();
            alert('Numeri estratti e stato tabella resettati.');
        }

        function handleResetProgression() {
            if (!isBettingPhase) {
                alert('Non c\'Ã¨ una progressione attiva da resettare.');
                return;
            }
            
            if (!confirm('Sei sicuro di voler resettare la PROGRESSIONE ATTIVA? I numeri estratti non verranno modificati.')) return;
            
            // Simula una perdita totale per archiviare lo stato come fallimento se necessario
            if (currentStep > 0 && winStepForArchive === null) {
                 const now = new Date();
                 const sessionData = {
                     date: now.toLocaleString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }),
                     saldo: currentSaldo,
                     winStep: 0,
                     win: false,
                 };
                 sessionArchives.push(sessionData);
                 saveStatsToCloud();
                 alert(`Progressione interrotta e sessione salvata come perdita. Saldo attuale: ${formatCurrency(currentSaldo)}`);
            }
            
            resetProgressionState();
            checkArchiviaButtonState();
            saveNumbersToCloud();
        }

        function togglePages(showPageId) {
            mainPage.style.display = 'none';
            statsPage.style.display = 'none';
            
            if (showPageId === 'main-page') {
                mainPage.style.display = 'block';
            } else if (showPageId === 'stats-page') {
                statsPage.style.display = 'block';
                updateStatsView();
            }
        }

        function updateStatsView() {
            let totalSaldo = 0;
            let totalWins = 0;
            let totalLosses = 0;
            
            sessionsBody.innerHTML = '';
            
            sessionArchives.forEach(session => {
                totalSaldo = session.saldo; // Aggiorna al saldo finale dell'ultima sessione
                session.win ? totalWins++ : totalLosses++;

                const row = sessionsBody.insertRow();
                const saldoClass = session.saldo >= 0 ? 'positive-saldo' : 'negative-saldo';
                const stepText = session.winStep > 0 ? `Step ${session.winStep}` : 'PERDITA';
                
                row.innerHTML = `
                    <td>${session.date}</td>
                    <td class="${saldoClass}">${formatCurrency(session.saldo)}</td>
                    <td>${stepText}</td>
                `;
            });
            
            const totalEvents = totalWins + totalLosses;
            const winPercentage = totalEvents > 0 ? ((totalWins / totalEvents) * 100).toFixed(1) : 0;
            
            totalSaldoElement.textContent = formatCurrency(totalSaldo);
            totalSaldoElement.className = totalSaldo >= 0 ? 'positive-saldo' : 'negative-saldo';
            totalEventsElement.textContent = totalEvents;
            totalWinsElement.textContent = totalWins;
            totalLossesElement.textContent = totalLosses;
            winPercentageElement.textContent = `${winPercentage}%`;
        }
        
        function handleResetArchive() {
            if (!confirm('Sei sicuro di voler CANCELLARE TUTTO l\'archivio delle statistiche? Questa azione Ã¨ irreversibile.')) return;
            
            sessionArchives = [];
            saveStatsToCloud();
            updateStatsView();
            alert('Archivio statistiche azzerato.');
        }

        function handleRecallLast10() {
            if (numeriEstratti.length < 10) {
                 alert('Non ci sono ancora 10 numeri estratti da richiamare.');
                 return;
            }
            
            if (!confirm('Sei sicuro di voler RICHIAMARE gli ultimi 10 numeri estratti? Questo ripristinerÃ  lo stato della tabella a 10 numeri fa, annullando quelli successivi.')) return;
            
            // 1. Taglia la lista
            const numeriDaMantenere = numeriEstratti.slice(10);
            numeriEstratti = numeriDaMantenere;
            
            // 2. Resetta lo stato delle righe (Bruciate e Medi)
            righeBruciate = new Array(12).fill(false);
            mediUscitiPerRiga = new Array(12).fill(0).map(() => new Set());
            
            // 3. Resetta lo stato di progressione
            resetProgressionState();
            winStepForArchive = null;
            
            // 4. Ricalcola lo stato della tabella (Evidenziate e Bruciate) con i numeri rimanenti
            righeTabella.forEach(row => {
                row.classList.remove('riga-bruciata');
                row.querySelectorAll('td').forEach(cell => cell.classList.remove('evidenziato'));
            });
            
            // Re-traccia i numeri (usando analyzeOnly=true)
            numeriEstratti.slice().reverse().forEach(numero => {
                 tracciaNumeroPreGame(numero, true);
            });
            reapplyBruciateAndEvidenziate(); // Assicura che le bruciate siano applicate visivamente

            updateEstrattiList();
            saveNumbersToCloud();
            checkRichiamaUltimiButtonState();
            alert('Ultimi 10 numeri estratti annullati. Stato ripristinato.');
        }
        
        function checkRichiamaUltimiButtonState() {
             btnRichiamaUltimi.disabled = isBettingPhase || numeriEstratti.length < 10;
        }

        function checkArchiviaButtonState() {
            btnArchiviaSaldo.disabled = winStepForArchive === null;
        }
        
        // ===============================================
        // EVENT LISTENERS
        // ===============================================

        inputEstratto.addEventListener('change', handleNumberInput);
        inputEstratto.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                handleNumberInput();
            }
        });
        valoreUnitarioInput.addEventListener('change', initializeProgressionTable);
        
        btnResetNumeri.addEventListener('click', resetAllNumbers);
        btnResetProgressione.addEventListener('click', handleResetProgression);

        // Funzione corretta per archiviare il saldo (Aggiunta chiave)
        btnArchiviaSaldo.addEventListener('click', archiveCurrentSession);
        
        btnVisualizzaArchivio.addEventListener('click', () => togglePages('stats-page'));
        btnTornaAllaPaginaPrincipale.addEventListener('click', () => togglePages('main-page'));
        btnResetArchivio.addEventListener('click', handleResetArchive);
        btnRichiamaUltimi.addEventListener('click', handleRecallLast10);
        
        // ===============================================
        // INIZIALIZZAZIONE
        // ===============================================
        fetchInitialData();
        
    </script>
</body>
</html>
